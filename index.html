<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>360° Virtual Tour Creator</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <style>
      body { margin: 0; font-family: Arial, sans-serif; }

      .editor-panel {
        position: fixed;
        top: 20px;
        left: 20px;
        z-index: 1000;
        background: rgba(255,255,255,0.92);
        padding: 15px;
        border-radius: 10px;
        width: 360px;
        max-width: calc(100vw - 40px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.18);
      }

      .editor-panel.view-mode .edit-only { display: none; }

      #fileInput, button, select {
        margin: 6px 0;
        padding: 8px;
        width: 100%;
        box-sizing: border-box;
      }

      .hint { font-size: 12px; opacity: 0.8; margin-top: 8px; line-height: 1.35; }
      .status { font-size: 12px; margin-top: 6px; opacity: 0.95; }
      .row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    </style>
  </head>

  <body>
    <div id="editorPanel" class="editor-panel">
      <h3 style="margin:0 0 10px 0;">Tour Editor</h3>

      <input type="file" id="fileInput" accept="image/*" />
      <div class="row">
        <button onclick="addPanorama()">Add Panorama</button>
        <button onclick="toggleEditMode()">Toggle Edit Mode</button>
      </div>

      <select id="hotspotTarget"></select>
      <button onclick="addHotspot()">Add Hotspot (center view)</button>

      <button onclick="finalizeTour()" class="edit-only">Finalize Tour (Export JSON)</button>

      <div id="status" class="status"></div>
      <div class="hint">
        Fluxo: adicione 2+ panoramas → selecione o alvo no dropdown (ele auto-seleciona) →
        olhe para onde quer o hotspot → clique “Add Hotspot” → clique na bolinha para abrir o panorama alvo.<br/>
        <b>Fix aplicado:</b> o raycaster agora só “enxerga” hotspots (o sky não bloqueia o clique).
      </div>
    </div>

    <a-scene id="scene">
      <a-assets id="assets"></a-assets>

      <!-- Panorama -->
      <a-sky id="panorama"></a-sky>

      <!-- Camada de hotspots -->
      <a-entity id="hotspotLayer"></a-entity>

      <!-- Camera -->
      <a-camera id="cam" look-controls="reverseMouseDrag: true">
        <!-- Cursor com rayOrigin mouse = clique do mouse funciona no desktop.
             IMPORTANTÍSSIMO: raycaster aponta SOMENTE para .hotspot,
             assim o sky não "rouba" a interseção do raio. -->
        <a-entity
          id="mouseCursor"
          cursor="rayOrigin: mouse"
          raycaster="objects: .hotspot; far: 100"
          position="0 0 -0.1"
          geometry="primitive: ring; radiusInner: 0.008; radiusOuter: 0.012"
          material="color: #FF0000; shader: flat; opacity: 0.9">
        </a-entity>
      </a-camera>
    </a-scene>

    <script>
      let panoramas = {};
      let currentPanorama = null;
      let editMode = true;

      const statusEl = document.getElementById("status");
      function setStatus(msg) { statusEl.textContent = msg || ""; }

      function addPanorama() {
        if (!editMode) return;

        const input = document.getElementById("fileInput");
        const file = input.files[0];
        if (!file) { setStatus("Selecione uma imagem primeiro."); return; }

        const reader = new FileReader();
        reader.onload = (e) => {
          const id = "pano_" + Object.keys(panoramas).length;
          panoramas[id] = { src: e.target.result, hotspots: [] };

          // Carrega o primeiro automaticamente
          if (!currentPanorama) {
            loadPanorama(id);
          } else {
            // Mantém dropdown atualizado mesmo sem trocar panorama
            updateHotspotTargets();
          }

          // Permite re-upload do mesmo arquivo
          input.value = "";
          setStatus(`Panorama adicionado: ${id}`);
        };
        reader.readAsDataURL(file);
      }

      function loadPanorama(id) {
        if (!panoramas[id]) return;

        currentPanorama = id;
        document.getElementById("panorama").setAttribute("src", panoramas[id].src);

        renderHotspots(id);
        updateHotspotTargets();

        setStatus(`Panorama atual: ${id}`);
      }

      function addHotspot() {
        if (!editMode) return;

        if (!currentPanorama) {
          setStatus("Carregue um panorama antes de criar hotspots.");
          return;
        }

        const select = document.getElementById("hotspotTarget");
        const target = select.value;

        if (!target) {
          setStatus("Não há alvo selecionado. Adicione 2+ panoramas para habilitar o dropdown.");
          return;
        }

        const camera = document.getElementById("cam");
        const rotation = camera.getAttribute("rotation");

        // Coloca hotspot “na frente” do utilizador, numa esfera de raio ~9.5
        const position = calculatePositionFromCamera(rotation, 9.5);

        panoramas[currentPanorama].hotspots.push({ position, target });

        renderHotspots(currentPanorama);
        setStatus(`Hotspot criado (vai para ${target}). Agora clique na bolinha vermelha.`);
      }

      // Cálculo estável para posicionar na direção do olhar
      function calculatePositionFromCamera(rotation, radius) {
        // yaw (Y) e pitch (X)
        const yaw = (rotation.y + 90) * Math.PI / 180;
        const pitch = (-rotation.x) * Math.PI / 180;

        const x = -radius * Math.cos(pitch) * Math.cos(yaw);
        const y =  radius * Math.sin(pitch);
        const z = -radius * Math.cos(pitch) * Math.sin(yaw);

        return { x, y, z };
      }

      function renderHotspots(panoId) {
        const layer = document.getElementById("hotspotLayer");
        layer.innerHTML = "";

        const hs = panoramas[panoId]?.hotspots || [];

        hs.forEach((hotspot, idx) => {
          const entity = document.createElement("a-sphere");

          // CLASSES IMPORTANTES:
          // - hotspot: para styling/seleção
          // - .hotspot é o alvo do raycaster (objects: .hotspot)
          entity.classList.add("hotspot");

          entity.setAttribute("position", hotspot.position);
          entity.setAttribute("radius", "0.35");

          // Material emissivo ajuda a ver bem e “pegar” clique
          entity.setAttribute("material",
            "shader: standard; color: #FF0000; emissive: #FF0000; emissiveIntensity: 0.75; metalness: 0.0; roughness: 0.6;"
          );

          // Garante que o raycaster detecte o objeto corretamente
          entity.setAttribute("visible", "true");

          // Clique abre o panorama alvo
          entity.addEventListener("click", (ev) => {
            // Algumas vezes o clique não dispara se o raycaster não intersectar.
            // Como o raycaster agora só pega .hotspot, isso fica consistente.
            if (hotspot.target && panoramas[hotspot.target]) {
              loadPanorama(hotspot.target);
              setStatus(`Abriu: ${hotspot.target}`);
            } else {
              setStatus("Hotspot sem alvo válido.");
            }
          });

          layer.appendChild(entity);
        });

        // Opcional: feedback
        if (hs.length === 0) setStatus(`Panorama ${panoId} sem hotspots ainda.`);
      }

      function updateHotspotTargets() {
        const select = document.getElementById("hotspotTarget");
        select.innerHTML = "";

        const ids = Object.keys(panoramas);

        // Sem 2 panoramas, não tem alvo para hotspot
        if (!currentPanorama || ids.length < 2) {
          const opt = document.createElement("option");
          opt.value = "";
          opt.textContent = ids.length < 2
            ? "Adicione pelo menos 2 panoramas..."
            : "Selecione um panorama alvo...";
          select.appendChild(opt);
          select.disabled = true;
          return;
        }

        select.disabled = false;

        // Adiciona opções (exceto o atual)
        ids.forEach((id) => {
          if (id !== currentPanorama) {
            const opt = document.createElement("option");
            opt.value = id;
            opt.textContent = id;
            select.appendChild(opt);
          }
        });

        // FIX #1: garantir que sempre exista um alvo selecionado automaticamente
        // (se tiver pelo menos 1 opção)
        if (select.options.length > 0) {
          select.selectedIndex = 0;
        } else {
          // Caso raro: só existe o panorama atual
          const opt = document.createElement("option");
          opt.value = "";
          opt.textContent = "Nenhum alvo disponível";
          select.appendChild(opt);
          select.disabled = true;
        }
      }

      function toggleEditMode() {
        editMode = !editMode;
        document.getElementById("editorPanel").classList.toggle("view-mode", !editMode);
        setStatus(editMode ? "Modo edição ON" : "Modo edição OFF");
      }

      function finalizeTour() {
        const tourData = JSON.stringify(panoramas, null, 2);
        const blob = new Blob([tourData], { type: "application/json" });
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = "virtual_tour.json";
        a.click();

        URL.revokeObjectURL(url);

        if (editMode) toggleEditMode();
      }

      // Inicialização
      updateHotspotTargets();
      setStatus("Pronto. Adicione panoramas para começar.");
    </script>
  </body>
</html>
