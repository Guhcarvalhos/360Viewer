<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>360° Virtual Tour Creator</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <style>
      body { margin: 0; font-family: Arial, sans-serif; }

      .editor-panel {
        position: fixed;
        top: 20px;
        left: 20px;
        z-index: 1000;
        background: rgba(255,255,255,0.92);
        padding: 15px;
        border-radius: 10px;
        width: 380px;
        max-width: calc(100vw - 40px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.18);
      }

      .editor-panel.view-mode .edit-only { display: none; }

      #fileInput, button, select {
        margin: 6px 0;
        padding: 8px;
        width: 100%;
        box-sizing: border-box;
      }

      .row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
      .hint { font-size: 12px; opacity: 0.82; margin-top: 8px; line-height: 1.35; }
      .status { font-size: 12px; margin-top: 6px; opacity: 0.95; }

      .pill {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 999px;
        background: rgba(0,0,0,0.06);
        font-size: 12px;
        margin-top: 6px;
      }
    </style>
  </head>

  <body>
    <div id="editorPanel" class="editor-panel">
      <h3 style="margin:0 0 10px 0;">Tour Editor</h3>

      <input type="file" id="fileInput" accept="image/*" />
      <div class="row">
        <button onclick="addPanorama()">Add Panorama</button>
        <button onclick="toggleEditMode()">Toggle Edit Mode</button>
      </div>

      <select id="hotspotTarget"></select>

      <div class="row">
        <button onclick="armHotspotPlacement()">Place Hotspot (center cursor)</button>
        <button onclick="cancelHotspotPlacement()">Cancel</button>
      </div>

      <button onclick="finalizeTour()" class="edit-only">Finalize Tour (Export JSON)</button>

      <div id="placementState" class="pill" style="display:none;">Placement mode: ON</div>
      <div id="status" class="status"></div>

      <div class="hint">
        Fluxo: adicione 2+ panoramas → selecione o alvo no dropdown → clique <b>Place Hotspot</b> →
        aponte o cursor (centro) para onde quer → clique/toque para fixar → clique no hotspot para trocar.
        <br/><b>Transição:</b> crossfade mais rápida (estilo Street View).
      </div>
    </div>

    <a-scene id="scene">
      <a-assets id="assets"></a-assets>

      <!-- DOIS SKIES para crossfade -->
      <a-sky id="skyA" material="transparent: true; opacity: 1" visible="true"></a-sky>
      <a-sky id="skyB" material="transparent: true; opacity: 0" visible="true"></a-sky>

      <!-- Camada de hotspots -->
      <a-entity id="hotspotLayer"></a-entity>

      <!-- Camera + cursor central -->
      <a-camera id="cam" look-controls="reverseMouseDrag: true">
        <a-cursor
          id="cursor"
          fuse="false"
          raycaster="objects: .hotspot, #skyA, #skyB; far: 100"
          material="color: #FF0000; shader: flat; opacity: 0.9"
          geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.015">
        </a-cursor>
      </a-camera>
    </a-scene>

    <script>
      // ---------- STATE ----------
      let panoramas = {};
      let currentPanorama = null;
      let editMode = true;

      // Crossfade state
      let activeSky = "A"; // "A" or "B"
      const FADE_MS = 250; // <<< TRANSIÇÃO MAIS RÁPIDA

      // Placement mode
      let placingHotspot = false;

      const statusEl = document.getElementById("status");
      const placementPill = document.getElementById("placementState");
      const cursorEl = document.getElementById("cursor");
      const hotspotLayer = document.getElementById("hotspotLayer");
      const skyA = document.getElementById("skyA");
      const skyB = document.getElementById("skyB");

      function setStatus(msg) { statusEl.textContent = msg || ""; }

      // ---------- PANORAMAS ----------
      function addPanorama() {
        if (!editMode) return;

        const input = document.getElementById("fileInput");
        const file = input.files[0];
        if (!file) { setStatus("Selecione uma imagem primeiro."); return; }

        const reader = new FileReader();
        reader.onload = (e) => {
          const id = "pano_" + Object.keys(panoramas).length;
          panoramas[id] = { src: e.target.result, hotspots: [] };

          if (!currentPanorama) {
            loadPanorama(id, /*withTransition*/ false);
          } else {
            updateHotspotTargets();
          }

          input.value = "";
          setStatus(`Panorama adicionado: ${id}`);
        };
        reader.readAsDataURL(file);
      }

      function loadPanorama(id, withTransition = true) {
        if (!panoramas[id]) return;
        currentPanorama = id;

        renderHotspots(id);
        updateHotspotTargets();

        if (withTransition) {
          crossfadeTo(panoramas[id].src);
        } else {
          if (activeSky === "A") {
            skyA.setAttribute("src", panoramas[id].src);
            skyA.setAttribute("material", "opacity", 1);
            skyB.setAttribute("material", "opacity", 0);
          } else {
            skyB.setAttribute("src", panoramas[id].src);
            skyB.setAttribute("material", "opacity", 1);
            skyA.setAttribute("material", "opacity", 0);
          }
        }

        setStatus(`Panorama atual: ${id}`);
      }

      // Crossfade rápido (Street View-like)
      function crossfadeTo(src) {
        const fromSky = activeSky === "A" ? skyA : skyB;
        const toSky   = activeSky === "A" ? skyB : skyA;

        toSky.setAttribute("src", src);
        toSky.setAttribute("material", "opacity", 0);

        fromSky.removeAttribute("animation__fadeout");
        toSky.removeAttribute("animation__fadein");

        fromSky.setAttribute("animation__fadeout", {
          property: "material.opacity",
          to: 0,
          dur: FADE_MS,
          easing: "linear"
        });

        toSky.setAttribute("animation__fadein", {
          property: "material.opacity",
          to: 1,
          dur: FADE_MS,
          easing: "linear"
        });

        activeSky = activeSky === "A" ? "B" : "A";
      }

      // ---------- HOTSPOT TARGETS ----------
      function updateHotspotTargets() {
        const select = document.getElementById("hotspotTarget");
        select.innerHTML = "";

        const ids = Object.keys(panoramas);
        if (!currentPanorama || ids.length < 2) {
          const opt = document.createElement("option");
          opt.value = "";
          opt.textContent = ids.length < 2
            ? "Adicione pelo menos 2 panoramas..."
            : "Selecione um panorama alvo...";
          select.appendChild(opt);
          select.disabled = true;
          return;
        }

        select.disabled = false;

        ids.forEach((id) => {
          if (id !== currentPanorama) {
            const opt = document.createElement("option");
            opt.value = id;
            opt.textContent = id;
            select.appendChild(opt);
          }
        });

        if (select.options.length > 0) select.selectedIndex = 0;
      }

      // ---------- HOTSPOT PLACEMENT (center cursor) ----------
      function armHotspotPlacement() {
        if (!editMode) return;
        if (!currentPanorama) { setStatus("Carregue um panorama antes."); return; }

        const target = document.getElementById("hotspotTarget").value;
        if (!target) { setStatus("Selecione um panorama alvo no dropdown."); return; }

        placingHotspot = true;
        placementPill.style.display = "inline-block";
        setStatus("Placement mode ON: aponte o cursor no centro e clique/toque para fixar o hotspot.");
      }

      function cancelHotspotPlacement() {
        placingHotspot = false;
        placementPill.style.display = "none";
        setStatus("Placement mode OFF.");
      }

      function handleSceneClick() {
        if (!placingHotspot) return;
        if (!currentPanorama) return;

        const select = document.getElementById("hotspotTarget");
        const target = select.value;
        if (!target) { setStatus("Sem alvo selecionado."); return; }

        const intersection = getCursorIntersectionWithActiveSky();
        if (!intersection) {
          setStatus("Não consegui obter ponto no panorama. Aponte o cursor para o céu e tente novamente.");
          return;
        }

        const localPos = worldToLocal(hotspotLayer, intersection.point);

        panoramas[currentPanorama].hotspots.push({
          position: { x: localPos.x, y: localPos.y, z: localPos.z },
          target
        });

        renderHotspots(currentPanorama);

        placingHotspot = false;
        placementPill.style.display = "none";
        setStatus(`Hotspot fixado. Clique na bolinha para abrir ${target}.`);
      }

      function getCursorIntersectionWithActiveSky() {
        const ray = cursorEl.components.raycaster;
        if (!ray) return null;

        const sky = (activeSky === "A") ? skyA : skyB;
        return ray.getIntersection(sky.object3D) || null;
      }

      function worldToLocal(entityEl, worldPoint) {
        const p = worldPoint.clone(); // THREE.Vector3
        entityEl.object3D.worldToLocal(p);
        return p;
      }

      // ---------- HOTSPOTS RENDER ----------
      function renderHotspots(panoId) {
        hotspotLayer.innerHTML = "";
        const hs = panoramas[panoId]?.hotspots || [];

        hs.forEach((hotspot) => {
          const entity = document.createElement("a-sphere");
          entity.classList.add("hotspot");

          entity.setAttribute("position", hotspot.position);
          entity.setAttribute("radius", "0.35");
          entity.setAttribute("material",
            "shader: standard; color: #FF0000; emissive: #FF0000; emissiveIntensity: 0.75; metalness: 0.0; roughness: 0.6;"
          );

          entity.addEventListener("click", () => {
            if (hotspot.target && panoramas[hotspot.target]) {
              loadPanorama(hotspot.target, true);
              setStatus(`Abriu: ${hotspot.target}`);
            } else {
              setStatus("Hotspot sem alvo válido.");
            }
          });

          hotspotLayer.appendChild(entity);
        });
      }

      // ---------- UI / EXPORT ----------
      function toggleEditMode() {
        editMode = !editMode;
        document.getElementById("editorPanel").classList.toggle("view-mode", !editMode);

        if (!editMode) cancelHotspotPlacement();

        setStatus(editMode ? "Modo edição ON" : "Modo edição OFF");
      }

      function finalizeTour() {
        const tourData = JSON.stringify(panoramas, null, 2);
        const blob = new Blob([tourData], { type: "application/json" });
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = "virtual_tour.json";
        a.click();

        URL.revokeObjectURL(url);

        if (editMode) toggleEditMode();
      }

      // ---------- EVENTS ----------
      document.querySelector("a-scene").addEventListener("click", handleSceneClick);
      document.querySelector("a-scene").addEventListener("touchend", handleSceneClick);

      updateHotspotTargets();
      setStatus("Pronto. Adicione panoramas para começar.");
    </script>
  </body>
</html>
